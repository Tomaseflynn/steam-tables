
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#0b5394">
    <title>Asistente de Cálculo de Ciclos de Vapor</title>
    <style>
        :root {
            --primary-color: #0b5394;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #6c757d;
            --border-color: #dee2e6;
            --text-color: #333;
            --error-bg: #f2dede;
            --error-text: #d9534f;
            --error-border: #ebccd1;
            --success-color: #28a745;
            --main-action-color: #dc3545;
            --secondary-action-color: #007bff;
            --highlight-bg: #fff3cd; /* Color para resaltar campos requeridos */
        }

        /* ... (Estilos base sin cambios) ... */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 1em; color: var(--text-color); background-color: var(--light-gray); }
        h1, h2, h3 { color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 0.5em; }
        h1 { font-size: 1.8em; } h2 { font-size: 1.5em; margin-top: 1.5em; } h3 { border: none; margin-top: 0; font-size: 1.2em; }
        table { border-collapse: collapse; width: 100%; margin-top: 1.5em; box-shadow: 0 0 10px rgba(0,0,0,0.05); }        
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        th, td { border: 1px solid var(--border-color); padding: 12px 8px; text-align: center; vertical-align: middle; min-width: 100px;}
        th { background-color: var(--medium-gray); font-weight: 600; position: sticky; top: 0; z-index: 1; }
        .unit { font-size: 0.8em; color: var(--dark-gray); font-weight: normal; }
        .description { text-align: left; width: 25%; min-width: 200px;}
        .point-id { width: 8%; font-weight: bold; background-color: var(--light-gray); min-width: 60px; }
        .ideal-point { color: var(--dark-gray); font-style: italic; }
        input[type="number"], input[type="text"] { width: 95%; border: 1px solid var(--border-color); padding: 12px 8px; text-align: right; border-radius: 5px; font-size: 16px; -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[readonly] { background-color: var(--medium-gray); cursor: not-allowed; }
        button { border: none; padding: 12px 16px; font-size: 16px; cursor: pointer; border-radius: 5px; color: white; font-weight: 500; }
        .point-calc-button { background-color: var(--secondary-action-color); }
        .cycle-params, .balances-container, .results-container, .calculation-center { background-color: #f0f0f0; padding: 1.5em; border-radius: 8px; margin-top: 2em; }
        .container-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5em; }
        .group { border: 1px solid #ccc; padding: 1em; border-radius: 5px; background-color: #fff;}
        .group label { display: block; margin: 1em 0 0.3em; font-size: 1em; }
        .error { color: var(--error-text); font-weight: bold; margin-top: 1em; background-color: var(--error-bg); border: 1px solid var(--error-border); padding: 15px; border-radius: 4px; }

        /* --- NUEVOS ESTILOS --- */
        .calculation-center select { width: 100%; padding: 12px 8px; font-size: 1.1em; border-radius: 5px; border: 1px solid var(--border-color); margin-bottom: 1em; }
        .calculation-center p { font-style: italic; color: var(--dark-gray); margin: 0 0 1.5em; }
        .execute-calc-button { background-color: var(--main-action-color); font-size: 1.2em; padding: 15px 25px; width: 100%; }
        .required-field { background-color: var(--highlight-bg) !important; transition: background-color 0.3s ease-in-out; }
    </style>
</head>
<body>
    <h1>Asistente de Ciclo de Vapor</h1>

    <div style="margin-bottom: 1em; background-color: #e9ecef; padding: 1em; border-radius: 5px;">
        <label>
            <input type="checkbox" id="auto-fill-checkbox" checked style="width: auto; height: auto;"> 
            <strong>Activar Relleno Automático Inteligente</strong>
        </label>
    </div>
    
    <h2>Puntos del Ciclo</h2>
    <div class="table-wrapper">
        <table id="points-table">
            <!-- ... (La tabla de puntos no cambia) ... -->
            <thead><tr><th class="point-id">Punto</th><th class="description">Descripción</th><th>Presión<br><span class="unit">(bar)</span></th><th>Temp.<br><span class="unit">(°C)</span></th><th>Entalpía<br><span class="unit">(kcal/kg)</span></th><th>Entropía<br><span class="unit">(kcal/kg·K)</span></th><th>Título<br><span class="unit">(0-1)</span></th><th>Acción</th></tr></thead>
            <tbody>
                {% for p_id, p_data in cycle_data.items() %}
                <tr class="point-row {{ 'ideal-point' if '_prime' in p_id }}" data-point-id="{{ p_id }}">
                    <td class="point-id">{{ p_id.replace('_prime', "'") }}</td>
                    <td class="description">{{ p_data.desc }}</td>
                    {% for prop in ['p', 't', 'h', 's', 'x'] %}<td><input type="number" inputmode="decimal" step="any" name="{{ p_id }}_{{ prop }}" class="point-input"></td>{% endfor %}
                    <td><button type="button" class="point-calc-button">Calcular</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="cycle-params container-grid">
        <div class="group">
            <h3>Rendimientos de Turbinas</h3>
            <label for="eta_hp">Rend. Turbina AP (%):</label>
            <input type="number" inputmode="decimal" step="any" id="eta_hp" name="eta_hp" value="85">
            <label for="eta_lp">Rend. Turbina BP (%):</label>
            <input type="number" inputmode="decimal" step="any" id="eta_lp" name="eta_lp" value="85">
            <button type="button" id="cycle-calc-button" class="point-calc-button" style="background-color:var(--success-color); font-size: 1em; padding: 15px; margin-top: 1em; width: 100%;">Calcular Expansiones</button>
        </div>
    </div>
    
    <h2>Parámetros y Resultados</h2>
    <div class="balances-container container-grid">
        <div class="group">
            <h3>Flujos Másicos</h3>
            <label for="Gv">Vapor Total (Gv) <span class="unit">(kg/h)</span></label><input type="number" inputmode="decimal" step="any" id="Gv" name="Gv">
            <label for="Gx">Vapor Extraído (Gx) <span class="unit">(kg/h)</span></label><input type="number" inputmode="decimal" step="any" id="Gx" name="Gx">
            <label for="Gc">Vapor Condensado (Gc) <span class="unit">(kg/h)</span></label><input type="number" inputmode="decimal" step="any" id="Gc" name="Gc">
        </div>
        <div class="group">
            <h3>Generador de Vapor</h3>
            <label for="rgv">Rendimiento G.V. (%)</label><input type="text" id="rgv" name="rgv" readonly>
            <label for="Gco">Consumo Combustible (Gco) <span class="unit">(kg/h)</span></label><input type="number" inputmode="decimal" step="any" id="Gco" name="Gco">
            <label for="Pci">Poder Calorífico Inferior (Pci) <span class="unit">(kcal/kg)</span></label><input type="number" inputmode="decimal" step="any" id="Pci" name="Pci">
        </div>
        <div class="group">
            <h3>Condensador</h3>
            <label for="Qc">Calor Intercambiado (Qc) <span class="unit">(kcal/h)</span></label><input type="text" id="Qc" name="Qc" readonly>
            <label for="W">Agua Refrigeración (W) <span class="unit">(kg/h)</span></label><input type="number" inputmode="decimal" step="any" id="W" name="W">
            <label for="ts">Temp. Salida Agua (°C)</label><input type="number" inputmode="decimal" step="any" id="ts" name="ts">
            <label for="te">Temp. Entrada Agua (°C)</label><input type="number" inputmode="decimal" step="any" id="te" name="te">
            <label for="Cp">Calor Específico Agua (Cp) <span class="unit">(kcal/kg°C)</span></label><input type="number" inputmode="decimal" step="any" id="Cp" name="Cp" value="1">
        </div>
         <div class="group">
            <h3>Resultados del Ciclo</h3>
            <label for="potencia_kw">Potencia Neta en Bornes (kW)</label><input type="text" id="potencia_kw" name="potencia_kw" readonly>
            <label for="ganancia_regeneracion">Ganancia por Regeneración (%)</label><input type="text" id="ganancia_regeneracion" name="ganancia_regeneracion" readonly>
        </div>
    </div>

    <!-- === NUEVO CENTRO DE CÁLCULO MODULAR === -->
    <h2>Centro de Cálculo</h2>
    <div class="calculation-center">
        <select id="calculation-select">
            <option value="" disabled selected>-- Seleccione un cálculo --</option>
        </select>
        <p id="calculation-description">Seleccione una operación para ver su descripción y los campos requeridos.</p>
        <button type="button" id="execute-calculation-button" class="execute-calc-button" disabled>Ejecutar Cálculo</button>
    </div>

    <div id="error-container" class="error" style="display: none;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- SETUP Y HELPERS (sin cambios) ---
    function getFloatValue(elementId) { const el = document.getElementById(elementId); return (el && el.value.trim() !== '') ? parseFloat(el.value.trim().replace(',', '.')) : null; }
    function getTableFloatValue(input) { return (input && input.value.trim() !== '') ? parseFloat(input.value.trim().replace(',', '.')) : undefined; }
    function setInputValue(input, value, decimals) { if (!input) return; input.value = (value !== null && value !== undefined) ? parseFloat(value).toFixed(decimals) : ''; }

    // --- LÓGICA DE AUTO-RELLENO (sin cambios) ---
    const autoFillCheckbox = document.getElementById('auto-fill-checkbox');
    const propagationGroups = [['1_s', '2_prime_s'], ['3_s', '4_prime_s', 'x_prime_s'], ['5_s', '6_prime_s'], ['1_p', '6_p', '6_prime_p'], ['2_p', '2_prime_p', 'n_p', '3_p'], ['4_p', '4_prime_p', '5_p'], ['x_p', 'x_prime_p', 'n_prime_p']];
    const propagationMap = {};
    propagationGroups.forEach(group => group.forEach(source => { if (!propagationMap[source]) propagationMap[source] = []; group.forEach(target => { if (source !== target) propagationMap[source].push(target); }); }));
    function propagateValue(sourceName, sourceValue) { if (autoFillCheckbox.checked && propagationMap[sourceName]) { propagationMap[sourceName].forEach(targetName => { const targetEl = document.querySelector(`[name="${targetName}"]`); if (targetEl) targetEl.value = sourceValue; }); } }
    document.getElementById('points-table').addEventListener('input', e => { if (e.target.classList.contains('point-input')) propagateValue(e.target.name, e.target.value.trim()); });

    // --- CÁLCULO DE PUNTO INDIVIDUAL (sin cambios) ---
    document.querySelectorAll('#points-table .point-calc-button').forEach(button => button.addEventListener('click', e => { /* ... Lógica sin cambios ... */
        const row = e.target.closest('tr'); if (!row) return; const pointId = row.dataset.pointId; const pointData = { id: pointId }; let count = 0;
        row.querySelectorAll('.point-input').forEach(inp => { const prop = inp.name.split('_').pop(); const val = getTableFloatValue(inp); if (val !== undefined) { pointData[prop] = val; count++; } });
        if (count < 2) return showError('Introduzca al menos dos propiedades.');
        fetch("{{ url_for('steam_tables.calculate_point') }}", { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(pointData) })
        .then(handleFetchResponse).then(data => { hideError(); for (const prop in data) { const input = row.querySelector(`[name="${pointId}_${prop}"]`); setInputValue(input, data[prop], 4); } for (const prop in data) { const input = row.querySelector(`[name="${pointId}_${prop}"]`); if (input) propagateValue(input.name, input.value); } })
        .catch(showError);
    }));

    // --- CÁLCULO DE EXPANSIONES (sin cambios) ---
    document.getElementById('cycle-calc-button').addEventListener('click', () => { /* ... Lógica sin cambios ... */
        const all_points = {}; document.querySelectorAll('#points-table tbody tr').forEach(row => { const pid = row.dataset.pointId; const pdata = {}; row.querySelectorAll('.point-input').forEach(inp => { const prop = inp.name.split('_').pop(); const val = getTableFloatValue(inp); if (val !== undefined) pdata[prop] = val; }); all_points[pid] = pdata; });
        const payload = { points: all_points, eta_hp: getFloatValue('eta_hp'), eta_lp: getFloatValue('eta_lp') };
        fetch("{{ url_for('steam_tables.calculate_cycle') }}", { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) })
        .then(handleFetchResponse).then(data => { hideError(); setInputValue(document.getElementById('eta_hp'), data.eta_hp, 2); setInputValue(document.getElementById('eta_lp'), data.eta_lp, 2); for (const p_id in data.points) { for (const prop in data.points[p_id]) { const input = document.querySelector(`[name="${p_id}_${prop}"]`); setInputValue(input, data.points[p_id][prop], 4); } } for (const p_id in data.points) { for (const prop in data.points[p_id]) { const input = document.querySelector(`[name="${p_id}_${prop}"]`); if (input) propagateValue(input.name, input.value); } } })
        .catch(showError);
    });

    // --- NUEVA LÓGICA DEL CENTRO DE CÁLCULO MODULAR ---
    const calcSelect = document.getElementById('calculation-select');
    const calcDesc = document.getElementById('calculation-description');
    const executeBtn = document.getElementById('execute-calculation-button');
    let calculationCatalog = [];

    // 1. Cargar el catálogo desde la nueva API
    fetch("{{ url_for('steam_tables.get_calculations_catalog') }}")
        .then(handleFetchResponse)
        .then(data => {
            calculationCatalog = data;
            data.forEach(calc => {
                const option = document.createElement('option');
                option.value = calc.id;
                option.textContent = calc.name;
                calcSelect.appendChild(option);
            });
        })
        .catch(err => showError(`No se pudo cargar el catálogo de cálculos: ${err.message}`));

    // 2. Gestionar la selección de un cálculo
    calcSelect.addEventListener('change', () => {
        const selectedId = calcSelect.value;
        const selectedCalc = calculationCatalog.find(c => c.id === selectedId);
        document.querySelectorAll('.required-field').forEach(el => el.classList.remove('required-field'));

        if (selectedCalc) {
            calcDesc.textContent = selectedCalc.description;
            executeBtn.disabled = false;

            // Resaltar campos de entrada requeridos
            if (selectedCalc.inputs.points) {
                selectedCalc.inputs.points.forEach(pointProp => {
                    const [p_id, prop] = pointProp.split(/_(.+)/);
                    const input = document.querySelector(`[name="${p_id}_${prop}"]`);
                    if (input) input.closest('td').classList.add('required-field');
                });
            }
            if (selectedCalc.inputs.params) {
                selectedCalc.inputs.params.forEach(paramId => {
                    const input = document.getElementById(paramId);
                    if (input) input.parentElement.classList.add('required-field');
                });
            }
        } else {
            calcDesc.textContent = 'Seleccione una operación para ver su descripción.';
            executeBtn.disabled = true;
        }
    });

    // 3. Ejecutar el cálculo seleccionado
    executeBtn.addEventListener('click', () => {
        const selectedId = calcSelect.value;
        if (!selectedId) return;

        const all_points = {};
        document.querySelectorAll('#points-table tbody tr').forEach(row => {
            const point_id = row.dataset.pointId;
            const point_data = {};
            row.querySelectorAll('.point-input').forEach(input => {
                const prop = input.name.split('_').pop();
                const value = getTableFloatValue(input);
                if (value !== undefined) point_data[prop] = value;
            });
            all_points[point_id] = point_data;
        });

        const all_params = {};
        const all_param_ids = ['Gv', 'Gx', 'Gc', 'rgv', 'Gco', 'Pci', 'W', 'ts', 'te', 'Cp', 'potencia_kw', 'ganancia_regeneracion', 'Qc'];
        all_param_ids.forEach(id => {
            const value = getFloatValue(id);
            if (value !== null) all_params[id] = value;
        });

        const payload = {
            id: selectedId,
            points: all_points,
            params: all_params
        };

        fetch("{{ url_for('steam_tables.execute_calculation') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(handleFetchResponse)
        .then(data => {
            hideError();
            const calculated_params = data.params;
            for (const paramId in calculated_params) {
                const input = document.getElementById(paramId);
                if (input) {
                    const decimals = ['rgv', 'ganancia_regeneracion', 'potencia_kw'].includes(paramId) ? 2 : 4;
                    setInputValue(input, calculated_params[paramId], decimals);
                }
            }
        })
        .catch(showError);
    });

    // --- UTILIDADES DE ERRORES Y RESPUESTAS (sin cambios) ---
    const errorDiv = document.getElementById('error-container');
    function showError(error) { errorDiv.textContent = error.message || error; errorDiv.style.display = 'block'; }
    function hideError() { errorDiv.style.display = 'none'; }
    function handleFetchResponse(response) {
        return response.json().then(data => {
            if (!response.ok) throw new Error(data.error || `Error: ${response.statusText}`);
            return data;
        });
    }
});
</script>

<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register("{{ url_for('static', filename='service-worker.js') }}").then(function(registration) {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, function(err) {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
</script>

</body>
</html>
