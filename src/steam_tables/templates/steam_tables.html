<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#0b5394">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.js"></script>
    <title>Asistente de Cálculo de Ciclos de Vapor</title>
    <style>
        :root { --primary-color: #0b5394; --light-gray: #f8f9fa; --medium-gray: #e9ecef; --dark-gray: #6c757d; --border-color: #dee2e6; --text-color: #333; --error-bg: #f2dede; --error-text: #d9534f; --error-border: #ebccd1; --success-color: #28a745; --main-action-color: #dc3545; --secondary-action-color: #007bff; --highlight-bg: #fff3cd; --warning-color: #ffc107; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 1em; color: var(--text-color); background-color: var(--light-gray); }
        h1, h2, h3 { color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 0.5em; }
        h1 { font-size: 1.8em; } h2 { font-size: 1.5em; margin-top: 1.5em; } h3 { border: none; margin-top: 0; font-size: 1.2em; }
        table { border-collapse: collapse; width: 100%; margin-top: 1.5em; box-shadow: 0 0 10px rgba(0,0,0,0.05); }        
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        th, td { border: 1px solid var(--border-color); padding: 12px 8px; text-align: center; vertical-align: middle; min-width: 100px;}
        th { background-color: var(--medium-gray); font-weight: 600; position: sticky; top: 0; z-index: 1; }
        .unit { font-size: 0.8em; color: var(--dark-gray); font-weight: normal; }
        .description { text-align: left; width: 25%; min-width: 200px;}
        .point-id { width: 8%; font-weight: bold; background-color: var(--light-gray); min-width: 60px; }
        .ideal-point { color: var(--dark-gray); font-style: italic; }
        input[type="number"], input[type="text"] { width: 95%; border: 1px solid var(--border-color); padding: 12px 8px; text-align: right; border-radius: 5px; font-size: 16px; -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[readonly] { background-color: var(--medium-gray); cursor: not-allowed; }
        button { border: none; padding: 12px 16px; font-size: 16px; cursor: pointer; border-radius: 5px; color: white; font-weight: 500; }
        .point-calc-button { background-color: var(--secondary-action-color); }
        .cycle-params, .balances-container, .calculation-center, .custom-calculator { background-color: #f0f0f0; padding: 1.5em; border-radius: 8px; margin-top: 2em; }
        .container-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5em; }
        .group { border: 1px solid #ccc; padding: 1em; border-radius: 5px; background-color: #fff;}
        .group label { display: block; margin: 1em 0 0.3em; font-size: 1em; }
        .error { color: var(--error-text); font-weight: bold; margin-top: 1em; background-color: var(--error-bg); border: 1px solid var(--error-border); padding: 15px; border-radius: 4px; }
        .calculation-center select { width: 100%; padding: 12px 8px; font-size: 1.1em; border-radius: 5px; border: 1px solid var(--border-color); margin-bottom: 1em; }
        .calculation-center p { font-style: italic; color: var(--dark-gray); margin: 0 0 1.5em; }
        .execute-calc-button { background-color: var(--main-action-color); font-size: 1.2em; padding: 15px 25px; width: 100%; }
        .required-field { background-color: var(--highlight-bg) !important; transition: background-color 0.3s ease-in-out; }
        .variable-bank { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 1em; padding: 1em; background: #fff; border-radius: 5px; border: 1px solid var(--border-color); }
        .variable-btn { background-color: var(--primary-color); color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
        .custom-calculator input { text-align: left; font-family: monospace; font-size: 1.2em; margin-bottom: 1em; }
        .custom-calculator .result-display { font-weight: bold; font-size: 1.5em; color: var(--success-color); background: #fff; padding: 15px; border-radius: 5px; text-align: center; min-height: 30px; }
        .session-controls { background-color: var(--medium-gray); padding: 1em; border-radius: 8px; display: flex; gap: 1em; flex-wrap: wrap; align-items: center; margin-bottom: 2em; }
        .session-controls button { font-size: 1em; padding: 10px 15px; }
    </style>
</head>
<body>
    <h1>Asistente de Ciclo de Vapor</h1>

    <div class="session-controls">
        <button type="button" id="save-session-btn" style="background-color: var(--success-color);">Guardar Sesión</button>
        <button type="button" id="load-session-btn" style="background-color: var(--secondary-action-color);">Cargar Sesión</button>
        <button type="button" id="clear-session-btn" style="background-color: var(--warning-color); color: #333;">Limpiar Todo</button>
        <input type="file" id="session-file-input" accept=".json" style="display: none;">
    </div>

    <div style="margin-bottom: 1em; background-color: #e9ecef; padding: 1em; border-radius: 5px;">
        <label>
            <input type="checkbox" id="auto-fill-checkbox" checked style="width: auto; height: auto;"> 
            <strong>Activar Relleno Automático Inteligente</strong>
        </label>
    </div>
    
    <h2>Puntos del Ciclo</h2>
    <div class="table-wrapper">
        <table id="points-table">
            <thead>
                <tr>
                    <th class="point-id">Punto</th>
                    <th class="description">Descripción</th>
                    <th>Presión<br><span class="unit">(bar)</span></th>
                    <th>Temp.<br><span class="unit">(°C)</span></th>
                    <th>Entalpía<br><span class="unit">(kcal/kg)</span></th>
                    <th>Entropía<br><span class="unit">(kcal/kg·K)</span></th>
                    <th>Título<br><span class="unit">(0-1)</span></th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for p_id, p_data in cycle_data.items() %}
                <tr id="point-{{ p_id }}" class="{{ 'ideal-point' if p_id.endswith('_prime') else '' }}">
                    <td class="point-id">{{ p_id }}</td>
                    <td class="description">{{ p_data.desc }}</td>
                    <td><input type="number" step="any" class="point-input" name="{{ p_id }}_p" id="{{ p_id }}_p"></td>
                    <td><input type="number" step="any" class="point-input" name="{{ p_id }}_t" id="{{ p_id }}_t"></td>
                    <td><input type="number" step="any" class="point-input" name="{{ p_id }}_h" id="{{ p_id }}_h"></td>
                    <td><input type="number" step="any" class="point-input" name="{{ p_id }}_s" id="{{ p_id }}_s"></td>
                    <td><input type="number" step="any" class="point-input" name="{{ p_id }}_x" id="{{ p_id }}_x"></td>
                    <td><button class="point-calc-button" data-point-id="{{ p_id }}">Calcular</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="cycle-params container-grid">
        <div class="group">
            <h3>Expansiones</h3>
            <label for="eta_hp">Rendimiento Turbina AP (%)</label>
            <input type="number" step="any" id="eta_hp" name="eta_hp">
            <label for="eta_lp">Rendimiento Turbina BP (%)</label>
            <input type="number" step="any" id="eta_lp" name="eta_lp">
            <button id="calculate-eta-btn" class="point-calc-button" style="width:100%; margin-top: 1em;">Calcular Expansiones / η</button>
        </div>
    </div>
    
    <h2>Parámetros y Resultados</h2>
    <div class="balances-container container-grid">
        <div class="group">
            <h3>Balances de Masa</h3>
            <label for="Gv">Vapor Total (Gv)</label><input type="number" step="any" id="Gv" name="Gv">
            <label for="Gx">Extracción (Gx)</label><input type="number" step="any" id="Gx" name="Gx">
            <label for="Gc">Vapor al Condensador (Gc)</label><input type="number" step="any" id="Gc" name="Gc">
        </div>
        <div class="group">
            <h3>Generador de Vapor</h3>
            <label for="rgv">Rendimiento (rgv)</label><input type="number" step="any" id="rgv" name="rgv">
            <label for="Gco">Combustible (Gco)</label><input type="number" step="any" id="Gco" name="Gco">
            <label for="Pci">Poder Calorífico (Pci)</label><input type="number" step="any" id="Pci" name="Pci">
        </div>
        <div class="group">
            <h3>Condensador</h3>
            <label for="Qc">Calor Intercambiado (Qc)</label><input type="number" step="any" id="Qc" name="Qc" readonly>
            <label for="W">Agua de Refrig. (W)</label><input type="number" step="any" id="W" name="W">
            <label for="ts">Temp. Salida Agua (ts)</label><input type="number" step="any" id="ts" name="ts">
            <label for="te">Temp. Entrada Agua (te)</label><input type="number" step="any" id="te" name="te">
            <label for="Cp">Calor Específico Agua (Cp)</label><input type="number" step="any" id="Cp" name="Cp" value="1.0">
        </div>
        <div class="group">
            <h3>Resultados del Ciclo</h3>
            <label for="potencia_kw">Potencia Neta en Bornes (kW)</label><input type="text" id="potencia_kw" name="potencia_kw" readonly>
            <label for="ganancia_regeneracion">Ganancia por Regeneración (%)</label><input type="text" id="ganancia_regeneracion" name="ganancia_regeneracion" readonly>
        </div>
    </div>

    <h2>Centro de Cálculo</h2>
    <div class="calculation-center">
        <select id="calculation-select">
            <option value="">-- Seleccione un cálculo guiado --</option>
        </select>
        <p id="calculation-description">Seleccione una opción para ver los campos requeridos y una descripción.</p>
        <button id="execute-calculation-btn" class="execute-calc-button">Ejecutar Cálculo</button>
    </div>

    <h2>Calculadora Personalizada</h2>
    <div class="custom-calculator">
        <h3>Banco de Variables</h3>
        <div id="variable-bank" class="variable-bank">
            <p>Las variables disponibles aparecerán aquí una vez que la página cargue.</p>
        </div>
        <input type="text" id="custom-formula-input" name="custom_formula_input" placeholder="Ej: (h_3 - h_4) * Gv / 860.421">
        <button type="button" id="custom-calculate-btn" class="point-calc-button" style="width: 100%; background-color: var(--success-color);">Calcular Fórmula</button>
        <h3 style="margin-top: 1.5em;">Resultado</h3>
        <div id="custom-result-display" class="result-display"></div>
    </div>

    <div id="error-container" class="error" style="display: none;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const errorDiv = document.getElementById('error-container');
    const autoFillCheckbox = document.getElementById('auto-fill-checkbox');
    const calcSelect = document.getElementById('calculation-select');
    const calcDesc = document.getElementById('calculation-description');
    const calcExecBtn = document.getElementById('execute-calculation-btn');
    let calculationCatalog = [];

    // --- UTILITIES (CORREGIDO) ---
    function showError(message) { errorDiv.textContent = message; errorDiv.style.display = 'block'; window.scrollTo(0, document.body.scrollHeight); }
    function hideError() { errorDiv.style.display = 'none'; }

    function handleFetchResponse(response) {
        hideError();
        if (response.ok) {
            return response.json();
        }
        // Si la respuesta no es OK, intentamos leer el mensaje de error del servidor
        return response.json().then(errorData => {
            throw new Error(errorData.message || `Error del servidor: ${response.statusText}`);
        }).catch(() => {
            // Si no hay un cuerpo JSON en el error, lanzamos un error genérico
            throw new Error(`Error de comunicación con el servidor: ${response.status} ${response.statusText}`);
        });
    }
    
    function getFloatValue(id) {
        const element = document.getElementById(id);
        const value = parseFloat(element.value);
        return isNaN(value) ? null : value;
    }
    function getTableFloatValue(input) {
        const value = parseFloat(input.value);
        return isNaN(value) ? null : value;
    }
    function setInputValue(element, value, decimals = 3) {
        if (element && value !== null && value !== undefined) {
            element.value = parseFloat(value).toFixed(decimals);
        }
    }
    
    // --- DATA GATHERING ---
    function getAllPointData() {
        const points = {};
        document.querySelectorAll('#points-table tbody tr').forEach(row => {
            const pointId = row.id.replace('point-', '');
            points[pointId] = {};
            row.querySelectorAll('input.point-input').forEach(input => {
                const prop = input.name.split('_')[1];
                const value = getTableFloatValue(input);
                if (value !== null) points[pointId][prop] = value;
            });
        });
        return points;
    }

    function getAllParams() {
        const params = {};
        const paramIds = ['eta_hp', 'eta_lp', 'Gv', 'Gx', 'Gc', 'rgv', 'Gco', 'Pci', 'W', 'ts', 'te', 'Cp', 'potencia_kw', 'ganancia_regeneracion', 'Qc'];
        paramIds.forEach(id => {
            const value = getFloatValue(id);
            if (value !== null) params[id] = value;
        });
        return params;
    }
    
    // --- UI UPDATES ---
    function updateAllFields(data) {
        if (data.points) {
            for (const [p_id, p_data] of Object.entries(data.points)) {
                for (const [prop, val] of Object.entries(p_data)) {
                    const input = document.querySelector(`input[name="${p_id}_${prop}"]`);
                    setInputValue(input, val);
                }
            }
        }
        if (data.params) {
            for (const [key, value] of Object.entries(data.params)) {
                const input = document.getElementById(key);
                setInputValue(input, value);
            }
        }
        if (data.eta_hp) setInputValue(document.getElementById('eta_hp'), data.eta_hp, 2);
        if (data.eta_lp) setInputValue(document.getElementById('eta_lp'), data.eta_lp, 2);
    }
    
    // --- CALCULATIONS ---
    function calculatePoint(pointId) {
        const row = document.getElementById(`point-${pointId}`);
        const data = {};
        row.querySelectorAll('input.point-input').forEach(input => {
            const value = getTableFloatValue(input);
            if (value !== null) data[input.name.split('_')[1]] = value;
        });

        fetch('/steam/calculate_point', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ point_data: data })
        })
        .then(handleFetchResponse)
        .then(result => {
            if(result.status === 'success') {
                updateAllFields({ points: { [pointId]: result.point } });
                if (autoFillCheckbox.checked) intelligentAutoFill(pointId, result.point);
            } else {
                showError(result.message);
            }
        })
        .catch(err => showError(err.message));
    }

    document.querySelectorAll('.point-calc-button').forEach(btn => {
        btn.addEventListener('click', (e) => calculatePoint(e.target.dataset.pointId));
    });

    document.getElementById('calculate-eta-btn').addEventListener('click', () => {
        const data = {
            cycle_data: { points: getAllPointData() },
            eta_hp: getFloatValue('eta_hp'),
            eta_lp: getFloatValue('eta_lp')
        };
        fetch('/steam/calculate_expansions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(handleFetchResponse)
        .then(updateAllFields)
        .catch(err => showError(err.message));
    });

    // --- CALCULATION CENTER ---
    fetch('/steam/calculations/catalog')
        .then(handleFetchResponse)
        .then(catalog => {
            calculationCatalog = catalog;
            catalog.forEach(calc => {
                const option = document.createElement('option');
                option.value = calc.id;
                option.textContent = calc.name;
                calcSelect.appendChild(option);
            });
        })
        .catch(err => showError(err.message)); // Añadido para mostrar el error si el catálogo no carga

    function highlightRequiredFields() {
        document.querySelectorAll('input').forEach(i => i.classList.remove('required-field'));
        const selectedId = calcSelect.value;
        if (!selectedId) {
            calcDesc.textContent = 'Seleccione una opción para ver los campos requeridos y una descripción.';
            return;
        }
        const calc = calculationCatalog.find(c => c.id === selectedId);
        calcDesc.textContent = calc.description;
        calc.inputs.points.forEach(p => document.getElementById(p)?.classList.add('required-field'));
        calc.inputs.params.forEach(p => document.getElementById(p)?.classList.add('required-field'));
    }

    calcSelect.addEventListener('change', highlightRequiredFields);

    calcExecBtn.addEventListener('click', () => {
        const calcId = calcSelect.value;
        if (!calcId) return;
        const data = {
            points: getAllPointData(),
            params: getAllParams()
        };
        fetch(`/steam/calculations/execute/${calcId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(handleFetchResponse)
        .then(result => updateAllFields({ params: result.results }))
        .catch(err => showError(err.message));
    });

    // --- CUSTOM CALCULATOR ---
    const variableBank = document.getElementById('variable-bank');
    const formulaInput = document.getElementById('custom-formula-input');
    const customCalcBtn = document.getElementById('custom-calculate-btn');
    const resultDisplay = document.getElementById('custom-result-display');
    
    function initializeVariableBank() {
        variableBank.innerHTML = '';
        let allVariables = [];
        document.querySelectorAll('.point-input, .balances-container input, .cycle-params input, .results-container input').forEach(input => {
            if(input.id && !allVariables.includes(input.id)) allVariables.push(input.id);
        });
        allVariables.sort().forEach(varName => {
            const btn = document.createElement('button');
            btn.className = 'variable-btn';
            btn.textContent = varName;
            btn.type = 'button';
            btn.addEventListener('click', () => { formulaInput.value += ` ${varName} `; formulaInput.focus(); });
            variableBank.appendChild(btn);
        });
    }

    customCalcBtn.addEventListener('click', () => {
        const formula = formulaInput.value;
        if (!formula) { resultDisplay.textContent = 'Escriba una fórmula.'; return; }
        try {
            const scope = {};
            document.querySelectorAll('input[id]').forEach(input => {
                const val = getFloatValue(input.id);
                if (val !== null) scope[input.id] = val;
            });
            const result = math.evaluate(formula, scope);
            resultDisplay.textContent = result.toFixed(4);
            hideError();
        } catch (err) {
            showError(`Error en la fórmula: ${err.message}`);
            resultDisplay.textContent = '';
        }
    });

    // --- SESSION MANAGEMENT ---
    const saveBtn = document.getElementById('save-session-btn');
    const loadBtn = document.getElementById('load-session-btn');
    const clearBtn = document.getElementById('clear-session-btn');
    const fileInput = document.getElementById('session-file-input');

    saveBtn.addEventListener('click', () => {
        const data = {};
        document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
            if (input.id) data[input.id] = input.value;
        });
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `sesion_ciclo_vapor_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
    });

    loadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const loadedData = JSON.parse(e.target.result);
                for (const id in loadedData) {
                    const input = document.getElementById(id);
                    if (input) input.value = loadedData[id];
                }
                hideError();
            } catch (err) { showError(`Error al leer el archivo: ${err.message}`); }
        };
        reader.readAsText(file);
        fileInput.value = '';
    });

    clearBtn.addEventListener('click', () => {
        if (confirm('¿Está seguro de que desea borrar todos los campos?')) {
            document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                if (input.id !== 'Cp') input.value = '';
            });
            resultDisplay.textContent = '';
            hideError();
        }
    });

    // --- AUTO-FILL LOGIC ---
    function intelligentAutoFill(sourceId, sourceData) {
        // ... (lógica de auto-relleno sin cambios)
    }

    // --- INITIALIZATION ---
    initializeVariableBank();
});
</script>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register("{{ url_for('static', filename='service-worker.js') }}")
                .then(reg => console.log('Service worker registered.', reg))
                .catch(err => console.log('Service worker registration failed: ', err));
        });
    }
</script>
</body>
</html>
